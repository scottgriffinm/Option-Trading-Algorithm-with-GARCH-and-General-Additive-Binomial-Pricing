{
 "cells": [
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<h1>Option Trading Algorithm with GARCH and General Additive Binomial Pricing</h1>"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Scott Griffin, The University of Iowa, 2023"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The <b>Generalized Autoregressive Conditional Heteroskedasticity (GARCH)</b> model is a statistical model used to analyze and forecast volatility in financial time series data."
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "The <b>General Additive Binomial Pricing Model</b> is a financial model used to value options. It's an extension of the classic binomial option pricing model, incorporating additional factors and complexities to provide more accurate option pricing."
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "In this notebook I'll build an option trading algorithm that implements these two models, then backtest it with historical option prices. The algorithm will look at four different underlying assets, chosen intentionally: AAPL (high volatility), KO (low volatility), SP500 (market), and BBBY (meme stock). All option prices were downloaded from Bloomberg with contract sizes of 100, and a time-to-expiry of one month."
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "\n",
    "The general idea of the trading algorithm's strategy is to:</br></br>(1) Look at a given market option quote</br></br>(2) Generate a price for that option using the General Additive Binomial Pricing model with a volatility predicted from a fitted GARCH model</br></br>(3) If the market price is some degree lower than our calculated price, buy the option and excercise if in the money during its term"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<h1>Index</h1>\n",
    "<hr>\n",
    "a. Imports</br>\n",
    "b. Function Declarations</br>\n",
    "c. Load Option Data</br>\n",
    "d. Constants</br>\n",
    "e. Simulation\n",
    "<hr>\n"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<h3>a. Imports"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "metadata": {},
   "outputs": [],
   "source": [
    "import math\n",
    "import csv\n",
    "import yfinance as yf\n",
    "from arch import arch_model"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<h3>b. Function Declarations"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {},
   "outputs": [],
   "source": [
    "def general_additive_binomial_valuation_american(K,T,S,sig,r,N,option_type):\n",
    "    '''\n",
    "    Price an American option using the General Additive Binomial Model.\n",
    "\n",
    "    Parameters\n",
    "    ----------\n",
    "    K : float\n",
    "        Strike price of the option.\n",
    "    T : float\n",
    "        Time to maturity of the option.\n",
    "    S : float\n",
    "        Current price of the underlying asset.\n",
    "    sig : float                                                                                                                                                                    \n",
    "        Volatility of the underlying asset.\n",
    "    r : float\n",
    "        Risk-free interest rate.\n",
    "    N : int\n",
    "        Number of time steps.\n",
    "    option_type : str\n",
    "        Type of option, either 'call' or 'put'.\n",
    "\n",
    "    Returns\n",
    "    -------\n",
    "    C : float\n",
    "        Price of the option.\n",
    "    '''\n",
    "\n",
    "    # check option type\n",
    "    if option_type not in ['call', 'put']:\n",
    "        raise ValueError(\"option_type must be either 'call' or 'put'\")\n",
    "\n",
    "    # set coefficents\n",
    "    dt = T/N\n",
    "    nu = r - 0.5*sig**2\n",
    "    dxu = math.sqrt(sig**2*dt + (nu*dt)**2)\n",
    "    dxd = -dxu\n",
    "    pu = 0.5 + 0.5*(nu*dt/dxu)\n",
    "    pd = 1-pu\n",
    "\n",
    "    # precompute constants\n",
    "    disc = math.exp(-r*dt)\n",
    "    dpu = disc*pu\n",
    "    dpd = disc*pd\n",
    "    edxud = math.exp(dxu-dxd)\n",
    "    edxd = math.exp(dxd)\n",
    "\n",
    "    # initialize asset prices at maturity N\n",
    "    St = [0]*(N+1)\n",
    "    St[0] = S*math.exp(N*dxd)\n",
    "    for i in range(1,N+1):\n",
    "        St[i] = St[i-1]*edxud\n",
    "    \n",
    "    # initialize option values at maturity\n",
    "    C = [0]*(N+1)\n",
    "    if option_type == 'put':\n",
    "        for i in range(0,N+1):\n",
    "            C[i] = max(0,K-St[i])\n",
    "    elif option_type == 'call':\n",
    "        for i in range(0,N+1):\n",
    "            C[i] = max(0,St[i]-K)\n",
    "        \n",
    "    # step back through the tree applying early exercise condition\n",
    "    for i in range(N,-1,-1):\n",
    "        for j in range(0,i):\n",
    "            C[j] = dpu*C[j+1] + dpd*C[j]\n",
    "            # adjust asset price to current time step\n",
    "            St[j] = St[j]/edxd\n",
    "            # apply early exercise condition\n",
    "            if option_type == 'put':\n",
    "                C[j] = max(C[j], K-St[j])\n",
    "            elif option_type == 'call':\n",
    "                C[j] = max(C[j], St[j]-K)\n",
    "                \n",
    "    return C[0]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "metadata": {},
   "outputs": [],
   "source": [
    "def pred_volatility(asset, data_date, years=5, p=1, q=1, dist='t', mean='Zero', vol='GARCH'):\n",
    "    '''\n",
    "    Predicts the volatility of an asset using GARCH model.\n",
    "    \n",
    "    Parameters\n",
    "    ----------\n",
    "    asset : str\n",
    "        Ticker symbol of asset.\n",
    "    data_date : str\n",
    "        Date of option data in format YYYY-MM-DD.\n",
    "    years : int\n",
    "        Number of years of historical data to use.\n",
    "    p : int\n",
    "        Number of lags of the conditional variance.\n",
    "    q : int\n",
    "        Number of lags of the conditional volatility.\n",
    "    dist : str\n",
    "        Distribution of the returns.\n",
    "    mean : str\n",
    "        Mean model of the returns.\n",
    "    vol : str\n",
    "        Volatility model of the returns.\n",
    "\n",
    "    Returns\n",
    "    -------\n",
    "    predicted_volatility : float\n",
    "        Predicted volatility of the asset.\n",
    "        '''\n",
    "    \n",
    "    # download historical data\n",
    "    start_date = str(int(data_date[:4])-years) + data_date[4:]\n",
    "    ticker = yf.Ticker(asset)\n",
    "    hist = ticker.history(interval=\"1mo\", start=start_date, end=data_date)\n",
    "\n",
    "    # calculate returns\n",
    "    returns = hist['Close'].pct_change().dropna()\n",
    "\n",
    "    # fit GARCH model\n",
    "    model = arch_model(returns, mean=mean, vol=vol, dist=dist, p=p, q=q, rescale=False)\n",
    "    fitted_model = model.fit(disp=\"off\")\n",
    "\n",
    "    # predict next months volatility\n",
    "    forecasts = fitted_model.forecast(horizon=1, reindex=False)\n",
    "    predicted_volatility = forecasts.variance.values[-1][0]\n",
    "\n",
    "    return predicted_volatility"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<h3>c. Load Option Data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "metadata": {},
   "outputs": [],
   "source": [
    "# import option data\n",
    "with open('option_data.csv', newline='') as csvfile:\n",
    "    option_data = []\n",
    "    spamreader = csv.reader(csvfile, delimiter=',', quotechar='|')\n",
    "    for row in spamreader:\n",
    "        option_data.append(row)\n",
    "    csvfile.close()\n",
    "option_data[0][0] = \"data_date\" # fix first header (csv start symbol at beginning)\n",
    "\n",
    "# split into option chains\n",
    "option_data = option_data[1:]\n",
    "option_chains = []\n",
    "temp_chain = [option_data[0]]\n",
    "for row in option_data:\n",
    "    if (row[0],row[3]) == (temp_chain[-1][0],temp_chain[-1][3]):\n",
    "        temp_chain.append(row)\n",
    "    else:\n",
    "        option_chains.append(temp_chain.copy())\n",
    "        temp_chain = [row]"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<h3>d. Constants"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "metadata": {},
   "outputs": [],
   "source": [
    "# trading algorithm\n",
    "EXCERCISE_LAG = 3\n",
    "BUY_IF_UNDERPRICED_BY_PCT = 0.1\n",
    "\n",
    "# garch model\n",
    "GARCH_HIST_YEARS = 4\n",
    "GARCH_P = 1\n",
    "GARCH_Q = 1\n",
    "GARCH_DISTRIBUTION = 't'\n",
    "\n",
    "# risk free rate\n",
    "RISK_FREE_ANNUAL = 0.035"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<h3>e. Simulation"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Starting simulation...\n",
      "\n",
      "AAPL 2/17/23 C125:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 12.9\n",
      "Calculated Price = 77.05\n",
      "Calculated Volatility = 0.010277403496754288\n",
      "ACTION = BUY (-$1290.0)\n",
      "Excercised at 135.06 after 3 days (+$1006.0)\n",
      "Account Value = -284.0\n",
      "\n",
      "AAPL 2/17/23 C125:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 12.9\n",
      "Calculated Price = 77.05\n",
      "Calculated Volatility = 0.010277403496754288\n",
      "ACTION = BUY (-$1290.0)\n",
      "Excercised at 135.06 after 3 days (+$1006.0)\n",
      "Account Value = -568.0\n",
      "\n",
      "AAPL 2/17/23 C130:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 9.15\n",
      "Calculated Price = 74.7\n",
      "Calculated Volatility = 0.010277403496754288\n",
      "ACTION = BUY (-$915.0)\n",
      "Excercised at 135.06 after 3 days (+$506.0)\n",
      "Account Value = -977.0\n",
      "\n",
      "AAPL 2/17/23 C135:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 5.95\n",
      "Calculated Price = 72.36\n",
      "Calculated Volatility = 0.010277403496754288\n",
      "ACTION = BUY (-$595.0)\n",
      "Excercised at 140.89 after 5 days (+$589.0)\n",
      "Account Value = -983.0\n",
      "\n",
      "AAPL 2/17/23 C140:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 3.5\n",
      "Calculated Price = 70.01\n",
      "Calculated Volatility = 0.010277403496754288\n",
      "ACTION = BUY (-$350.0)\n",
      "Excercised at 141.64 after 7 days (+$164.0)\n",
      "Account Value = -1169.0\n",
      "\n",
      "AAPL 2/17/23 C145:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 1.82\n",
      "Calculated Price = 67.66\n",
      "Calculated Volatility = 0.010277403496754288\n",
      "ACTION = BUY (-$182.0)\n",
      "Excercised at 154.26 after 14 days (+$926.0)\n",
      "Account Value = -425.0\n",
      "\n",
      "^GSPC 2/17/23 C3980:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 92.6\n",
      "Calculated Price = 2122.68\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION = BUY (-$9260.0)\n",
      "Excercised at 4016.22 after 7 days (+$3622.0)\n",
      "Account Value = -6063.0\n",
      "\n",
      "^GSPC 2/17/23 C3985:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 89.6\n",
      "Calculated Price = 2120.34\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION = BUY (-$8960.0)\n",
      "Excercised at 4016.22 after 7 days (+$3122.0)\n",
      "Account Value = -11901.0\n",
      "\n",
      "^GSPC 2/17/23 C3990:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 86.7\n",
      "Calculated Price = 2117.99\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION = BUY (-$8670.0)\n",
      "Excercised at 4016.22 after 7 days (+$2622.0)\n",
      "Account Value = -17949.0\n",
      "\n",
      "^GSPC 2/17/23 C3995:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 83.8\n",
      "Calculated Price = 2115.64\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION = BUY (-$8380.0)\n",
      "Excercised at 4016.22 after 7 days (+$2122.0)\n",
      "Account Value = -24207.0\n",
      "\n",
      "^GSPC 2/17/23 C4000:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 81.1\n",
      "Calculated Price = 2113.3\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION = BUY (-$8110.0)\n",
      "Excercised at 4016.22 after 7 days (+$1622.0)\n",
      "Account Value = -30695.0\n",
      "\n",
      "KO 2/17/23 C57.5:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 4.65\n",
      "Calculated Price = 34.22\n",
      "Calculated Volatility = 0.0024464646478960573\n",
      "ACTION = BUY (-$465.0)\n",
      "Excercised at 59.27 after 3 days (+$177.0)\n",
      "Account Value = -30983.0\n",
      "\n",
      "KO 2/17/23 C60:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 2.55\n",
      "Calculated Price = 33.04\n",
      "Calculated Volatility = 0.0024464646478960573\n",
      "ACTION = BUY (-$255.0)\n",
      "Excercised at 60.35 after 8 days (+$35.0)\n",
      "Account Value = -31203.0\n",
      "\n",
      "KO 2/17/23 C62.5:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 1.05\n",
      "Calculated Price = 31.87\n",
      "Calculated Volatility = 0.0024464646478960573\n",
      "ACTION = BUY (-$105.0)\n",
      "Option expired without excercise\n",
      "Account Value = -31308.0\n",
      "\n",
      "KO 2/17/23 C65:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 0.28\n",
      "Calculated Price = 30.7\n",
      "Calculated Volatility = 0.0024464646478960573\n",
      "ACTION = BUY (-$28.0)\n",
      "Option expired without excercise\n",
      "Account Value = -31336.0\n",
      "\n",
      "KO 2/17/23 C67.5:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 0.06\n",
      "Calculated Price = 29.52\n",
      "Calculated Volatility = 0.0024464646478960573\n",
      "ACTION = BUY (-$6.0)\n",
      "Option expired without excercise\n",
      "Account Value = -31342.0\n",
      "\n",
      "BBBY 2/17/23 C2:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 2.16\n",
      "Calculated Price = 3.18\n",
      "Calculated Volatility = 0.1725766741922117\n",
      "ACTION = BUY (-$216.0)\n",
      "Excercised at 3.79 after 3 days (+$179.0)\n",
      "Account Value = -31379.0\n",
      "\n",
      "BBBY 2/17/23 C3:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 1.58\n",
      "Calculated Price = 2.72\n",
      "Calculated Volatility = 0.1725766741922117\n",
      "ACTION = BUY (-$158.0)\n",
      "Excercised at 3.79 after 3 days (+$79.0)\n",
      "Account Value = -31458.0\n",
      "\n",
      "BBBY 2/17/23 C4:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 1.22\n",
      "Calculated Price = 2.25\n",
      "Calculated Volatility = 0.1725766741922117\n",
      "ACTION = BUY (-$122.0)\n",
      "Option expired without excercise\n",
      "Account Value = -31580.0\n",
      "\n",
      "BBBY 2/17/23 C5:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 1.05\n",
      "Calculated Price = 1.79\n",
      "Calculated Volatility = 0.1725766741922117\n",
      "ACTION = BUY (-$105.0)\n",
      "Option expired without excercise\n",
      "Account Value = -31685.0\n",
      "\n",
      "BBBY 2/17/23 C6:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 0.81\n",
      "Calculated Price = 1.33\n",
      "Calculated Volatility = 0.1725766741922117\n",
      "ACTION = BUY (-$81.0)\n",
      "Option expired without excercise\n",
      "Account Value = -31766.0\n",
      "\n",
      "AAPL 2/17/23 P125:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 1.78\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.010267131422507531\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "AAPL 2/17/23 P130:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 2.98\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.010267131422507531\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "AAPL 2/17/23 P135:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 4.75\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.010267131422507531\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "AAPL 2/17/23 P140:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 7.25\n",
      "Calculated Price = 4.27\n",
      "Calculated Volatility = 0.010267131422507531\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "AAPL 2/17/23 P145:\n",
      "Today = 2023-01-17, S = 135.73\n",
      "Broker Price = 10.55\n",
      "Calculated Price = 9.27\n",
      "Calculated Volatility = 0.010267131422507531\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "^GSPC 2/17/23 P3980:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 72.6\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "^GSPC 2/17/23 P3985:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 74.7\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "^GSPC 2/17/23 P3990:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 76.7\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "^GSPC 2/17/23 P3995:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 78.8\n",
      "Calculated Price = 4.03\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "^GSPC 2/17/23 P4000:\n",
      "Today = 2023-01-17, S = 3990.97\n",
      "Broker Price = 81.0\n",
      "Calculated Price = 9.03\n",
      "Calculated Volatility = 0.0033589399726129112\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "KO 2/17/23 P57.5:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 0.31\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0024453526950032924\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "KO 2/17/23 P60:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 0.73\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0024453526950032924\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "KO 2/17/23 P62.5:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 1.68\n",
      "Calculated Price = 1.29\n",
      "Calculated Volatility = 0.0024453526950032924\n",
      "ACTION: NONE\n",
      "Account Value = -31766.0\n",
      "\n",
      "KO 2/17/23 P65:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 3.4\n",
      "Calculated Price = 3.79\n",
      "Calculated Volatility = 0.0024453526950032924\n",
      "ACTION = BUY (-$340.0)\n",
      "Excercised at 59.27 after 3 days (+$573.0)\n",
      "Account Value = -31533.0\n",
      "\n",
      "KO 2/17/23 P67.5:\n",
      "Today = 2023-01-17, S = 61.21\n",
      "Broker Price = 5.8\n",
      "Calculated Price = 6.29\n",
      "Calculated Volatility = 0.0024453526950032924\n",
      "ACTION: NONE\n",
      "Account Value = -31533.0\n",
      "\n",
      "BBBY 2/17/23 P2:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 0.56\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.17257632559994734\n",
      "ACTION: NONE\n",
      "Account Value = -31533.0\n",
      "\n",
      "BBBY 2/17/23 P3:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 1.14\n",
      "Calculated Price = 0.01\n",
      "Calculated Volatility = 0.17257632559994734\n",
      "ACTION: NONE\n",
      "Account Value = -31533.0\n",
      "\n",
      "BBBY 2/17/23 P4:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 1.87\n",
      "Calculated Price = 0.01\n",
      "Calculated Volatility = 0.17257632559994734\n",
      "ACTION: NONE\n",
      "Account Value = -31533.0\n",
      "\n",
      "BBBY 2/17/23 P5:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 2.67\n",
      "Calculated Price = 0.86\n",
      "Calculated Volatility = 0.17257632559994734\n",
      "ACTION: NONE\n",
      "Account Value = -31533.0\n",
      "\n",
      "BBBY 2/17/23 P6:\n",
      "Today = 2023-01-17, S = 4.14\n",
      "Broker Price = 3.5\n",
      "Calculated Price = 1.86\n",
      "Calculated Volatility = 0.17257632559994734\n",
      "ACTION: NONE\n",
      "Account Value = -31533.0\n",
      "\n",
      "AAPL 3/17/23 C145:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 9.7\n",
      "Calculated Price = 84.48\n",
      "Calculated Volatility = 0.008132452876302747\n",
      "ACTION = BUY (-$970.0)\n",
      "Excercised at 148.91 after 3 days (+$391.0)\n",
      "Account Value = -32112.0\n",
      "\n",
      "AAPL 3/17/23 C150:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 6.15\n",
      "Calculated Price = 82.14\n",
      "Calculated Volatility = 0.008132452876302747\n",
      "ACTION = BUY (-$615.0)\n",
      "Excercised at 151.6 after 12 days (+$160.0)\n",
      "Account Value = -32567.0\n",
      "\n",
      "AAPL 3/17/23 C155:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 3.4\n",
      "Calculated Price = 79.79\n",
      "Calculated Volatility = 0.008132452876302747\n",
      "ACTION = BUY (-$340.0)\n",
      "Option expired without excercise\n",
      "Account Value = -32907.0\n",
      "\n",
      "AAPL 3/17/23 C160:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 1.57\n",
      "Calculated Price = 77.44\n",
      "Calculated Volatility = 0.008132452876302747\n",
      "ACTION = BUY (-$157.0)\n",
      "Option expired without excercise\n",
      "Account Value = -33064.0\n",
      "\n",
      "AAPL 3/17/23 C165:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 0.61\n",
      "Calculated Price = 75.1\n",
      "Calculated Volatility = 0.008132452876302747\n",
      "ACTION = BUY (-$61.0)\n",
      "Option expired without excercise\n",
      "Account Value = -33125.0\n",
      "\n",
      "^GSPC 3/17/23 C4070:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 89.4\n",
      "Calculated Price = 2168.56\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION = BUY (-$8940.0)\n",
      "Option expired without excercise\n",
      "Account Value = -42065.0\n",
      "\n",
      "^GSPC 3/17/23 C4075:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 86.4\n",
      "Calculated Price = 2166.21\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION = BUY (-$8640.0)\n",
      "Option expired without excercise\n",
      "Account Value = -50705.0\n",
      "\n",
      "^GSPC 3/17/23 C4080:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 83.4\n",
      "Calculated Price = 2163.86\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION = BUY (-$8340.0)\n",
      "Option expired without excercise\n",
      "Account Value = -59045.0\n",
      "\n",
      "^GSPC 3/17/23 C4085:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 80.5\n",
      "Calculated Price = 2161.52\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION = BUY (-$8050.0)\n",
      "Option expired without excercise\n",
      "Account Value = -67095.0\n",
      "\n",
      "^GSPC 3/17/23 C4090:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 77.6\n",
      "Calculated Price = 2159.17\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION = BUY (-$7760.0)\n",
      "Option expired without excercise\n",
      "Account Value = -74855.0\n",
      "\n",
      "KO 3/17/23 C55:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 5.25\n",
      "Calculated Price = 33.84\n",
      "Calculated Volatility = 0.002150330610019417\n",
      "ACTION = BUY (-$525.0)\n",
      "Excercised at 59.52 after 3 days (+$452.0)\n",
      "Account Value = -74928.0\n",
      "\n",
      "KO 3/17/23 C57.5:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 2.9\n",
      "Calculated Price = 32.67\n",
      "Calculated Volatility = 0.002150330610019417\n",
      "ACTION = BUY (-$290.0)\n",
      "Excercised at 59.52 after 3 days (+$202.0)\n",
      "Account Value = -75016.0\n",
      "\n",
      "KO 3/17/23 C60:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 1.05\n",
      "Calculated Price = 31.49\n",
      "Calculated Volatility = 0.002150330610019417\n",
      "ACTION = BUY (-$105.0)\n",
      "Option expired without excercise\n",
      "Account Value = -75121.0\n",
      "\n",
      "KO 3/17/23 C62.5:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 0.17\n",
      "Calculated Price = 30.32\n",
      "Calculated Volatility = 0.002150330610019417\n",
      "ACTION = BUY (-$17.0)\n",
      "Option expired without excercise\n",
      "Account Value = -75138.0\n",
      "\n",
      "KO 3/17/23 C65:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 0.03\n",
      "Calculated Price = 29.15\n",
      "Calculated Volatility = 0.002150330610019417\n",
      "ACTION = BUY (-$3.0)\n",
      "Option expired without excercise\n",
      "Account Value = -75141.0\n",
      "\n",
      "BBBY 3/17/23 C1:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 0.79\n",
      "Calculated Price = 1.33\n",
      "Calculated Volatility = 0.15974577677675178\n",
      "ACTION = BUY (-$79.0)\n",
      "Excercised at 1.62 after 3 days (+$62.0)\n",
      "Account Value = -75158.0\n",
      "\n",
      "BBBY 3/17/23 C1.5:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 0.46\n",
      "Calculated Price = 1.1\n",
      "Calculated Volatility = 0.15974577677675178\n",
      "ACTION = BUY (-$46.0)\n",
      "Excercised at 1.62 after 3 days (+$12.0)\n",
      "Account Value = -75192.0\n",
      "\n",
      "BBBY 3/17/23 C2:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 0.3\n",
      "Calculated Price = 0.87\n",
      "Calculated Volatility = 0.15974577677675178\n",
      "ACTION = BUY (-$30.0)\n",
      "Option expired without excercise\n",
      "Account Value = -75222.0\n",
      "\n",
      "BBBY 3/17/23 C2.5:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 0.23\n",
      "Calculated Price = 0.64\n",
      "Calculated Volatility = 0.15974577677675178\n",
      "ACTION = BUY (-$23.0)\n",
      "Option expired without excercise\n",
      "Account Value = -75245.0\n",
      "\n",
      "BBBY 3/17/23 C3:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 0.19\n",
      "Calculated Price = 0.4\n",
      "Calculated Volatility = 0.15974577677675178\n",
      "ACTION = BUY (-$19.0)\n",
      "Option expired without excercise\n",
      "Account Value = -75264.0\n",
      "\n",
      "AAPL 3/17/23 P145:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 1.91\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.00813205740648797\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "AAPL 3/17/23 P150:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 3.35\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.00813205740648797\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "AAPL 3/17/23 P155:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 5.55\n",
      "Calculated Price = 2.45\n",
      "Calculated Volatility = 0.00813205740648797\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "AAPL 3/17/23 P160:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 8.65\n",
      "Calculated Price = 7.45\n",
      "Calculated Volatility = 0.00813205740648797\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "AAPL 3/17/23 P165:\n",
      "Today = 2023-02-17, S = 152.55\n",
      "Broker Price = 12.75\n",
      "Calculated Price = 12.45\n",
      "Calculated Volatility = 0.00813205740648797\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "^GSPC 3/17/23 P4070:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 73.4\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "^GSPC 3/17/23 P4075:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 75.4\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "^GSPC 3/17/23 P4080:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 77.4\n",
      "Calculated Price = 0.91\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "^GSPC 3/17/23 P4085:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 79.4\n",
      "Calculated Price = 5.91\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "^GSPC 3/17/23 P4090:\n",
      "Today = 2023-02-17, S = 4079.09\n",
      "Broker Price = 81.6\n",
      "Calculated Price = 10.91\n",
      "Calculated Volatility = 0.0024858072969791262\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "KO 3/17/23 P55:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 0.11\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.002147207570754981\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "KO 3/17/23 P57.5:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 0.31\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.002147207570754981\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "KO 3/17/23 P60:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 1.07\n",
      "Calculated Price = 0.34\n",
      "Calculated Volatility = 0.002147207570754981\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "KO 3/17/23 P62.5:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 2.76\n",
      "Calculated Price = 2.84\n",
      "Calculated Volatility = 0.002147207570754981\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "KO 3/17/23 P65:\n",
      "Today = 2023-02-17, S = 59.66\n",
      "Broker Price = 5.15\n",
      "Calculated Price = 5.34\n",
      "Calculated Volatility = 0.002147207570754981\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "BBBY 3/17/23 P1:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 0.07\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.15974583686355237\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "BBBY 3/17/23 P1.5:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 0.27\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.15974583686355237\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "BBBY 3/17/23 P2:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 0.59\n",
      "Calculated Price = 0.19\n",
      "Calculated Volatility = 0.15974583686355237\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "BBBY 3/17/23 P2.5:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 1.02\n",
      "Calculated Price = 0.69\n",
      "Calculated Volatility = 0.15974583686355237\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "BBBY 3/17/23 P3:\n",
      "Today = 2023-02-17, S = 1.81\n",
      "Broker Price = 1.47\n",
      "Calculated Price = 1.19\n",
      "Calculated Volatility = 0.15974583686355237\n",
      "ACTION: NONE\n",
      "Account Value = -75264.0\n",
      "\n",
      "AAPL 4/21/23 C155:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 7.7\n",
      "Calculated Price = 86.52\n",
      "Calculated Volatility = 0.009668692430557027\n",
      "ACTION = BUY (-$770.0)\n",
      "Excercised at 158.93 after 3 days (+$393.0)\n",
      "Account Value = -75641.0\n",
      "\n",
      "AAPL 4/21/23 C157.5:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 6.0\n",
      "Calculated Price = 85.35\n",
      "Calculated Volatility = 0.009668692430557027\n",
      "ACTION = BUY (-$600.0)\n",
      "Excercised at 158.93 after 3 days (+$143.0)\n",
      "Account Value = -76098.0\n",
      "\n",
      "AAPL 4/21/23 C160:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 4.55\n",
      "Calculated Price = 84.17\n",
      "Calculated Volatility = 0.009668692430557027\n",
      "ACTION = BUY (-$455.0)\n",
      "Excercised at 164.9 after 9 days (+$490.0)\n",
      "Account Value = -76063.0\n",
      "\n",
      "AAPL 4/21/23 C162.5:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 3.3\n",
      "Calculated Price = 83.0\n",
      "Calculated Volatility = 0.009668692430557027\n",
      "ACTION = BUY (-$330.0)\n",
      "Excercised at 165.63 after 11 days (+$313.0)\n",
      "Account Value = -76080.0\n",
      "\n",
      "AAPL 4/21/23 C165:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 2.26\n",
      "Calculated Price = 81.83\n",
      "Calculated Volatility = 0.009668692430557027\n",
      "ACTION = BUY (-$226.0)\n",
      "Excercised at 165.23 after 19 days (+$23.0)\n",
      "Account Value = -76283.0\n",
      "\n",
      "^GSPC 4/21/23 C3995:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 99.9\n",
      "Calculated Price = 2127.54\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION = BUY (-$9990.0)\n",
      "Excercised at 4109.31 after 9 days (+$11431.0)\n",
      "Account Value = -74842.0\n",
      "\n",
      "^GSPC 4/21/23 C4000:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 96.9\n",
      "Calculated Price = 2125.2\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION = BUY (-$9690.0)\n",
      "Excercised at 4109.31 after 9 days (+$10931.0)\n",
      "Account Value = -73601.0\n",
      "\n",
      "^GSPC 4/21/23 C4005:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 93.8\n",
      "Calculated Price = 2122.85\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION = BUY (-$9380.0)\n",
      "Excercised at 4109.31 after 9 days (+$10431.0)\n",
      "Account Value = -72550.0\n",
      "\n",
      "^GSPC 4/21/23 C4010:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 90.9\n",
      "Calculated Price = 2120.5\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION = BUY (-$9090.0)\n",
      "Excercised at 4109.31 after 9 days (+$9931.0)\n",
      "Account Value = -71709.0\n",
      "\n",
      "^GSPC 4/21/23 C4015:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 87.9\n",
      "Calculated Price = 2118.16\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION = BUY (-$8790.0)\n",
      "Excercised at 4109.31 after 9 days (+$9431.0)\n",
      "Account Value = -71068.0\n",
      "\n",
      "KO 4/21/23 C59:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 2.17\n",
      "Calculated Price = 32.62\n",
      "Calculated Volatility = 0.0027109533085171015\n",
      "ACTION = BUY (-$217.0)\n",
      "Excercised at 59.92 after 3 days (+$92.0)\n",
      "Account Value = -71193.0\n",
      "\n",
      "KO 4/21/23 C60:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 1.47\n",
      "Calculated Price = 32.15\n",
      "Calculated Volatility = 0.0027109533085171015\n",
      "ACTION = BUY (-$147.0)\n",
      "Excercised at 61.42 after 6 days (+$142.0)\n",
      "Account Value = -71198.0\n",
      "\n",
      "KO 4/21/23 C61:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 0.9\n",
      "Calculated Price = 31.69\n",
      "Calculated Volatility = 0.0027109533085171015\n",
      "ACTION = BUY (-$90.0)\n",
      "Excercised at 61.86 after 7 days (+$86.0)\n",
      "Account Value = -71202.0\n",
      "\n",
      "KO 4/21/23 C62:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 0.48\n",
      "Calculated Price = 31.22\n",
      "Calculated Volatility = 0.0027109533085171015\n",
      "ACTION = BUY (-$48.0)\n",
      "Excercised at 62.21 after 11 days (+$21.0)\n",
      "Account Value = -71229.0\n",
      "\n",
      "KO 4/21/23 C62.5:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 0.33\n",
      "Calculated Price = 30.98\n",
      "Calculated Volatility = 0.0027109533085171015\n",
      "ACTION = BUY (-$33.0)\n",
      "Excercised at 62.69 after 14 days (+$19.0)\n",
      "Account Value = -71243.0\n",
      "\n",
      "BBBY 4/21/23 C0.5:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 0.33\n",
      "Calculated Price = 0.58\n",
      "Calculated Volatility = 0.1708925270193142\n",
      "ACTION = BUY (-$33.0)\n",
      "Excercised at 0.79 after 3 days (+$29.0)\n",
      "Account Value = -71247.0\n",
      "\n",
      "BBBY 4/21/23 C1:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 0.14\n",
      "Calculated Price = 0.35\n",
      "Calculated Volatility = 0.1708925270193142\n",
      "ACTION = BUY (-$14.0)\n",
      "Option expired without excercise\n",
      "Account Value = -71261.0\n",
      "\n",
      "BBBY 4/21/23 C1.5:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 0.08\n",
      "Calculated Price = 0.12\n",
      "Calculated Volatility = 0.1708925270193142\n",
      "ACTION = BUY (-$8.0)\n",
      "Option expired without excercise\n",
      "Account Value = -71269.0\n",
      "\n",
      "BBBY 4/21/23 C2:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 0.06\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.1708925270193142\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "BBBY 4/21/23 C2.5:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 0.05\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.1708925270193142\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "AAPL 4/21/23 P155:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 2.92\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.009663272768165209\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "AAPL 4/21/23 P157.5:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 3.75\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.009663272768165209\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "AAPL 4/21/23 P160:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 4.75\n",
      "Calculated Price = 0.72\n",
      "Calculated Volatility = 0.009663272768165209\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "AAPL 4/21/23 P162.5:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 5.95\n",
      "Calculated Price = 3.22\n",
      "Calculated Volatility = 0.009663272768165209\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "AAPL 4/21/23 P165:\n",
      "Today = 2023-03-21, S = 159.28\n",
      "Broker Price = 7.45\n",
      "Calculated Price = 5.72\n",
      "Calculated Volatility = 0.009663272768165209\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "^GSPC 4/21/23 P3995:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 77.6\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "^GSPC 4/21/23 P4000:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 79.5\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "^GSPC 4/21/23 P4005:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 81.4\n",
      "Calculated Price = 2.13\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "^GSPC 4/21/23 P4010:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 83.4\n",
      "Calculated Price = 7.13\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "^GSPC 4/21/23 P4015:\n",
      "Today = 2023-03-21, S = 4002.87\n",
      "Broker Price = 85.5\n",
      "Calculated Price = 12.13\n",
      "Calculated Volatility = 0.002583887996719143\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "KO 4/21/23 P59:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 0.61\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0027442966158973676\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "KO 4/21/23 P60:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 0.92\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0027442966158973676\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "KO 4/21/23 P61:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 1.33\n",
      "Calculated Price = 0.68\n",
      "Calculated Volatility = 0.0027442966158973676\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "KO 4/21/23 P62:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 1.91\n",
      "Calculated Price = 1.68\n",
      "Calculated Volatility = 0.0027442966158973676\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "KO 4/21/23 P62.5:\n",
      "Today = 2023-03-21, S = 60.32\n",
      "Broker Price = 2.28\n",
      "Calculated Price = 2.18\n",
      "Calculated Volatility = 0.0027442966158973676\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "BBBY 4/21/23 P0.5:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 0.04\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.17089332836733373\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "BBBY 4/21/23 P1:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 0.32\n",
      "Calculated Price = 0.18\n",
      "Calculated Volatility = 0.17089332836733373\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "BBBY 4/21/23 P1.5:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 0.77\n",
      "Calculated Price = 0.68\n",
      "Calculated Volatility = 0.17089332836733373\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "BBBY 4/21/23 P2:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 1.27\n",
      "Calculated Price = 1.18\n",
      "Calculated Volatility = 0.17089332836733373\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "BBBY 4/21/23 P2.5:\n",
      "Today = 2023-03-21, S = 0.82\n",
      "Broker Price = 1.72\n",
      "Calculated Price = 1.68\n",
      "Calculated Volatility = 0.17089332836733373\n",
      "ACTION: NONE\n",
      "Account Value = -71269.0\n",
      "\n",
      "AAPL 5/19/23 C160:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 10.05\n",
      "Calculated Price = 92.52\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION = BUY (-$1005.0)\n",
      "Excercised at 165.02 after 3 days (+$502.0)\n",
      "Account Value = -71772.0\n",
      "\n",
      "AAPL 5/19/23 C165:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 6.6\n",
      "Calculated Price = 90.18\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION = BUY (-$660.0)\n",
      "Excercised at 165.02 after 3 days (+$2.0)\n",
      "Account Value = -72430.0\n",
      "\n",
      "AAPL 5/19/23 C170:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 3.7\n",
      "Calculated Price = 87.83\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION = BUY (-$370.0)\n",
      "Excercised at 171.77 after 15 days (+$177.0)\n",
      "Account Value = -72623.0\n",
      "\n",
      "AAPL 5/19/23 C175:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 1.76\n",
      "Calculated Price = 85.48\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION = BUY (-$176.0)\n",
      "Option expired without excercise\n",
      "Account Value = -72799.0\n",
      "\n",
      "AAPL 5/19/23 C180:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 0.7\n",
      "Calculated Price = 83.13\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION = BUY (-$70.0)\n",
      "Option expired without excercise\n",
      "Account Value = -72869.0\n",
      "\n",
      "^GSPC 5/19/23 C4145:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 75.9\n",
      "Calculated Price = 2208.78\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION = BUY (-$7590.0)\n",
      "Option expired without excercise\n",
      "Account Value = -80459.0\n",
      "\n",
      "^GSPC 5/19/23 C4150:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 72.8\n",
      "Calculated Price = 2206.43\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION = BUY (-$7280.0)\n",
      "Option expired without excercise\n",
      "Account Value = -87739.0\n",
      "\n",
      "^GSPC 5/19/23 C4155:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 69.6\n",
      "Calculated Price = 2204.09\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION = BUY (-$6960.0)\n",
      "Option expired without excercise\n",
      "Account Value = -94699.0\n",
      "\n",
      "^GSPC 5/19/23 C4160:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 66.6\n",
      "Calculated Price = 2201.74\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION = BUY (-$6660.0)\n",
      "Option expired without excercise\n",
      "Account Value = -101359.0\n",
      "\n",
      "^GSPC 5/19/23 C4165:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 63.9\n",
      "Calculated Price = 2199.39\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION = BUY (-$6390.0)\n",
      "Option expired without excercise\n",
      "Account Value = -107749.0\n",
      "\n",
      "KO 5/19/23 C57.5:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 6.4\n",
      "Calculated Price = 36.69\n",
      "Calculated Volatility = 0.0027575885887732732\n",
      "ACTION = BUY (-$640.0)\n",
      "Excercised at 64.05 after 3 days (+$655.0)\n",
      "Account Value = -107734.0\n",
      "\n",
      "KO 5/19/23 C60:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 4.0\n",
      "Calculated Price = 35.51\n",
      "Calculated Volatility = 0.0027575885887732732\n",
      "ACTION = BUY (-$400.0)\n",
      "Excercised at 64.05 after 3 days (+$405.0)\n",
      "Account Value = -107729.0\n",
      "\n",
      "KO 5/19/23 C62.5:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 1.88\n",
      "Calculated Price = 34.34\n",
      "Calculated Volatility = 0.0027575885887732732\n",
      "ACTION = BUY (-$188.0)\n",
      "Excercised at 64.05 after 3 days (+$155.0)\n",
      "Account Value = -107762.0\n",
      "\n",
      "KO 5/19/23 C65:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 0.48\n",
      "Calculated Price = 33.17\n",
      "Calculated Volatility = 0.0027575885887732732\n",
      "ACTION = BUY (-$48.0)\n",
      "Option expired without excercise\n",
      "Account Value = -107810.0\n",
      "\n",
      "KO 5/19/23 C67.5:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 0.04\n",
      "Calculated Price = 31.99\n",
      "Calculated Volatility = 0.0027575885887732732\n",
      "ACTION = BUY (-$4.0)\n",
      "Option expired without excercise\n",
      "Account Value = -107814.0\n",
      "\n",
      "BBBY 5/19/23 C0.5:\n",
      "Today = 2023-04-19, S = 0.46\n",
      "Broker Price = 0.17\n",
      "Calculated Price = 0.22\n",
      "Calculated Volatility = 0.20474282758075063\n",
      "ACTION = BUY (-$17.0)\n",
      "Option expired without excercise\n",
      "Account Value = -107831.0\n",
      "\n",
      "BBBY 5/19/23 C1:\n",
      "Today = 2023-04-19, S = 0.46\n",
      "Broker Price = 0.1\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.20474282758075063\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "BBBY 5/19/23 C1.5:\n",
      "Today = 2023-04-19, S = 0.46\n",
      "Broker Price = 0.06\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.20474282758075063\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "BBBY 5/19/23 C2:\n",
      "Today = 2023-04-19, S = 0.46\n",
      "Broker Price = 0.05\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.20474282758075063\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "BBBY 5/19/23 C2.5:\n",
      "Today = 2023-04-19, S = 0.46\n",
      "Broker Price = 0.04\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.20474282758075063\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "AAPL 5/19/23 P160:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 2.17\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "AAPL 5/19/23 P165:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 3.6\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "AAPL 5/19/23 P170:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 5.7\n",
      "Calculated Price = 2.37\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "AAPL 5/19/23 P175:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 8.7\n",
      "Calculated Price = 7.37\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "AAPL 5/19/23 P180:\n",
      "Today = 2023-04-19, S = 167.63\n",
      "Broker Price = 11.95\n",
      "Calculated Price = 12.37\n",
      "Calculated Volatility = 0.007925321006058078\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "^GSPC 5/19/23 P4145:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 58.9\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "^GSPC 5/19/23 P4150:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 60.7\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "^GSPC 5/19/23 P4155:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 62.6\n",
      "Calculated Price = 0.48\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "^GSPC 5/19/23 P4160:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 64.5\n",
      "Calculated Price = 5.48\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "^GSPC 5/19/23 P4165:\n",
      "Today = 2023-04-19, S = 4154.52\n",
      "Broker Price = 66.2\n",
      "Calculated Price = 10.48\n",
      "Calculated Volatility = 0.0022162089122641213\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "KO 5/19/23 P57.5:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 0.07\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0027640198600968864\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "KO 5/19/23 P60:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 0.16\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0027640198600968864\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "KO 5/19/23 P62.5:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 0.52\n",
      "Calculated Price = 0.0\n",
      "Calculated Volatility = 0.0027640198600968864\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "KO 5/19/23 P65:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 1.6\n",
      "Calculated Price = 1.32\n",
      "Calculated Volatility = 0.0027640198600968864\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "KO 5/19/23 P67.5:\n",
      "Today = 2023-04-19, S = 63.68\n",
      "Broker Price = 3.8\n",
      "Calculated Price = 3.82\n",
      "Calculated Volatility = 0.0027640198600968864\n",
      "ACTION: NONE\n",
      "Account Value = -107831.0\n",
      "\n",
      "--------------------------------------------\n",
      "Final Account Value = -107831.0\n",
      "--------------------------------------------\n"
     ]
    }
   ],
   "source": [
    "# start simulation\n",
    "print(\"Starting simulation...\")\n",
    "account_value = 0\n",
    "RISK_FREE_MONTHLY = RISK_FREE_ANNUAL**(1/12)\n",
    "\n",
    "# for each option chain\n",
    "for option_chain in option_chains:\n",
    "    asset = option_chain[0][3]\n",
    "    data_date = option_chain[0][0]\n",
    "    strike_date = option_chain[0][4]\n",
    "    future_prices = yf.Ticker(asset).history(start=data_date, end=strike_date)\n",
    "    S = round(float(future_prices['Close'][0]),2)\n",
    "\n",
    "    # predict volatility on the underlying asset\n",
    "    predicted_volatility = pred_volatility(asset, data_date, years=GARCH_HIST_YEARS, p=GARCH_P, q=GARCH_Q, dist=GARCH_DISTRIBUTION)\n",
    "\n",
    "    # calculate prices for each option listing\n",
    "    calculated_prices = []\n",
    "    for option in option_chain:\n",
    "        K = float(option[1])\n",
    "        option_type = option[5].lower()\n",
    "        calculated_prices.append(round(general_additive_binomial_valuation_american(K,1,S,predicted_volatility,RISK_FREE_MONTHLY,1,option_type),2))\n",
    "\n",
    "    for i in range(len(option_chain)):\n",
    "        # for each option in the option chain\n",
    "        print(f'''\\n{option_chain[i][2]}:''')\n",
    "        print(f'''Today = {data_date}, S = {S}''')\n",
    "        broker_price = round(float(option_chain[i][6]),2)\n",
    "        print(f'''Broker Price = {broker_price}\\nCalculated Price = {calculated_prices[i]}\\nCalculated Volatility = {predicted_volatility}''')\n",
    "        # if underpriced\n",
    "        if calculated_prices[i] > broker_price*(1+BUY_IF_UNDERPRICED_BY_PCT):\n",
    "            cost = round(broker_price*100,2)\n",
    "            print(f\"ACTION = BUY (-${cost})\")\n",
    "            account_value -= cost\n",
    "            K = round(float(option_chain[i][1]),2)\n",
    "            lag = 0\n",
    "            days = 0\n",
    "            excercised = False\n",
    "            # step through future daily prices and excercise if profitable after lag\n",
    "            for asset_price in future_prices['Close']:\n",
    "                asset_price = round(asset_price,2)\n",
    "                days +=1\n",
    "                if option_type == 'call':\n",
    "                    if asset_price > K:\n",
    "                        lag += 1\n",
    "                        if lag >= EXCERCISE_LAG:\n",
    "                            profit = round((asset_price - K)*100,2)\n",
    "                            print(f\"Excercised at {asset_price} after {days} days (+${profit})\")\n",
    "                            excercised = True\n",
    "                            account_value += profit\n",
    "                            account_value = round(account_value,2)\n",
    "                            print(f\"Account Value = {account_value}\")\n",
    "                            break\n",
    "                    else:\n",
    "                        lag = 0\n",
    "                elif option_type == 'put':\n",
    "                    if asset_price < K:\n",
    "                        lag += 1\n",
    "                        if lag >= EXCERCISE_LAG:\n",
    "                            profit = round((K - asset_price)*100,2)\n",
    "                            print(f\"Excercised at {asset_price} after {days} days (+${profit})\")\n",
    "                            excercised = True\n",
    "                            account_value += profit\n",
    "                            account_value = round(account_value,2)\n",
    "                            print(f\"Account Value = {account_value}\")\n",
    "                            break\n",
    "                    else:\n",
    "                        lag = 0\n",
    "            if excercised == False:\n",
    "                print(f\"Option expired without excercise\")\n",
    "                print(f\"Account Value = {account_value}\")\n",
    "\n",
    "        # if overpriced\n",
    "        else:\n",
    "            print(\"ACTION: NONE\")\n",
    "            print(f\"Account Value = {account_value}\")\n",
    "            continue\n",
    "\n",
    "print(f'''\\n--------------------------------------------\n",
    "Final Account Value = {account_value}\n",
    "--------------------------------------------''')"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "ENV",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.5"
  },
  "orig_nbformat": 4
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
